<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Time Series Dashboard</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
    background: #f7f9fc;
    margin: 0;
}
.container {
    max-width: 1100px;
    margin: auto;
    padding: 40px;
}
h1 { text-align: center; }
h2 {
    margin-top: 40px;
    border-bottom: 2px solid #ddd;
    padding-bottom: 8px;
}
.card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
.row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    align-items: center;
}
label {
    font-size: 14px;
    font-weight: 500;
}
input, select {
    padding: 8px;
    width: 160px;
    border-radius: 6px;
    border: 1px solid #ccc;
}
button {
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    background: #4f46e5;
    color: white;
    cursor: pointer;
    font-weight: 600;
}
button:hover { background: #4338ca; }
.btn-secondary { background: #64748b; }
.btn-secondary:hover { background: #475569; }
.footer {
    margin-top: 60px;
    text-align: center;
    color: #666;
}
pre {
    background: #f3f4f6;
    padding: 12px;
    border-radius: 8px;
    max-height: 300px;
    overflow-y: auto;
}
</style>
</head>

<body>
<div class="container">

<h1>ðŸ“ˆ Time Series Analytics</h1>
<p style="text-align:center;">EDA & Forecasting Service</p>

<!-- ================= EDA ================= -->

<h2>ðŸ“Š Exploratory Data Analysis</h2>

<div class="card">
<h3>Close Price</h3>
<div class="row">
<label>Ticker <select id="cp_ticker"></select></label>
<label>Start <input id="cp_start" type="date" value="2023-01-01"></label>
<label>End <input id="cp_end" type="date" value="2023-12-31"></label>
<button onclick="openClosePrice()">Show</button>
</div>
</div>

<div class="card">
<h3>Daily Returns</h3>
<div class="row">
<label>Ticker <select id="ret_ticker"></select></label>
<label>Start <input id="ret_start" type="date" value="2023-01-01"></label>
<label>End <input id="ret_end" type="date" value="2023-12-31"></label>
<button onclick="openReturns()">Show</button>
</div>
</div>

<div class="card">
<h3>Structural Breaks</h3>
<div class="row">
<label>Ticker <select id="sb_ticker"></select></label>
<label>Start <input id="sb_start" type="date" value="2020-01-01"></label>
<label>End <input id="sb_end" type="date" value="2024-12-31"></label>
<label>Kernel <input id="sb_kernel" type="number" value="5"></label>
<label>PELT <input id="sb_pelt" type="number" value="5"></label>
<button onclick="openStructuralBreaks()">Show</button>
</div>
</div>

<div class="card">
<h3>Correlation</h3>
<div class="row">
<label>Ticker <select id="corr_ticker"></select></label>
<button onclick="openCorrelation()">Show</button>
</div>
</div>

<div class="card">
<h3>ACF / PACF</h3>
<div class="row">
<label>Ticker <select id="acf_ticker"></select></label>
<label>Feature <select id="acf_feature"></select></label>
<label>Lags <input id="acf_lags" type="number" value="40"></label>
<button onclick="openACFPACF()">Show</button>
</div>
</div>

<div class="card">
<h3>Lag Plot</h3>
<div class="row">
<label>Ticker <select id="lag_ticker"></select></label>
<label>Feature <select id="lag_feature"></select></label>
<label>Lag <input id="lag_lag" type="number" value="1"></label>
<button onclick="openLagPlot()">Show</button>
</div>
</div>

<!-- ================= FORECAST ================= -->

<h2>ðŸ”® Forecasting</h2>

<div class="card">
<h3>Forecast (POST /forward)</h3>

<div class="row">
<label>Ticker <select id="fc_ticker"></select></label>
<label>Target <select id="fc_target"></select></label>
<label>Horizon <input id="fc_horizon" type="number" value="10"></label>
<label>Model
<select id="fc_model">
<option value="naive">naive</option>
<option value="seasonal_naive">seasonal_naive</option>
<option value="moving_average">moving_average</option>
<option value="drift">drift</option>
<option value="exp_smoothing">exp_smoothing</option>
</select>
</label>
<button onclick="openForecast()">Run</button>
</div>

<div id="forecast_result" class="card" style="display:none;">
<h3>Forecast Result</h3>
<pre id="forecast_output"></pre>
</div>
</div>

<div class="card">
<button class="btn-secondary" onclick="window.open('/docs','_blank')">
Open Swagger Docs
</button>
</div>

<div class="footer">
FastAPI Â· Time Series Â· EDA & Forecasting
</div>

</div>

<!-- ================= SCRIPT ================= -->

<script>
async function fillSelect(id, url, def=null) {
    const el = document.getElementById(id);
    const res = await fetch(url);
    const data = await res.json();
    el.innerHTML = "";
    data.forEach(v => {
        const o = document.createElement("option");
        o.value = v;
        o.text = v;
        el.appendChild(o);
    });
    if (def && data.includes(def)) el.value = def;
}

window.onload = async () => {
    const tickers = [
        "cp_ticker","ret_ticker","sb_ticker","corr_ticker",
        "acf_ticker","lag_ticker","fc_ticker"
    ];

    for (const t of tickers) {
        await fillSelect(t, "/meta/tickers", "AAPL");
    }

    await fillSelect("acf_feature", "/meta/features", "Close");
    await fillSelect("lag_feature", "/meta/features", "Close");
    await fillSelect("fc_target", "/meta/features", "Close");
};

function openClosePrice() {
    window.open(`/eda/close-price?ticker=${cp_ticker.value}&start_date=${cp_start.value}&end_date=${cp_end.value}`);
}
function openReturns() {
    window.open(`/eda/returns?ticker=${ret_ticker.value}&start_date=${ret_start.value}&end_date=${ret_end.value}`);
}
function openStructuralBreaks() {
    window.open(`/eda/structural-breaks?ticker=${sb_ticker.value}&start_date=${sb_start.value}&end_date=${sb_end.value}&kernel_n_bkps=${sb_kernel.value}&pelt_penalty=${sb_pelt.value}`);
}
function openCorrelation() {
    window.open(`/eda/correlation?ticker=${corr_ticker.value}`);
}
function openACFPACF() {
    window.open(`/eda/acf-pacf?ticker=${acf_ticker.value}&feature=${acf_feature.value}&lags=${acf_lags.value}`);
}
function openLagPlot() {
    window.open(`/eda/lag-plot?ticker=${lag_ticker.value}&feature=${lag_feature.value}&lag=${lag_lag.value}`);
}

async function openForecast() {
    const payload = {
        ticker: fc_ticker.value,
        target: fc_target.value,
        horizon: Number(fc_horizon.value),
        model: fc_model.value
    };

    try {
        const res = await fetch("/forward", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            alert("ÐœÐ¾Ð´ÐµÐ»ÑŒ Ð½Ðµ ÑÐ¼Ð¾Ð³Ð»Ð° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ");
            return;
        }

        const data = await res.json();
        renderForecast(data);

    } catch (e) {
        alert("ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ Ñ ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð¼");
        console.error(e);
    }
}

function renderForecast(data) {
    const block = document.getElementById("forecast_result");
    const out = document.getElementById("forecast_output");

    block.style.display = "block";

    out.textContent =
        `Ticker: ${data.ticker}\n` +
        `Target: ${data.target}\n` +
        `Model: ${data.model}\n` +
        `Horizon: ${data.horizon}\n\n` +
        data.forecast
            .map(d => `${d.date}: ${d.value.toFixed(2)}`)
            .join("\n");
}
</script>

</body>
</html>
